<!DOCTYPE html>
<html>
<head>
    <title>图书管理员-图书查询</title>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <link rel="stylesheet" type="text/css" href="../font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="../style/adMain.css">
    <link rel="stylesheet" type="text/css" href="../style/adCheckBook.css">
    <script type="text/javascript" src="../script/jquery-2.1.4.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var left_li = $(".left ul li:eq(6)");
            left_li.css("color", "#FFF");
            left_li.css("background-color", "#BBCAF1");
            $(".left ul").find('li:eq(6)').children(".trig").css('display', 'block');
            $(".table tbody tr:odd").css("backgroundColor", "#FCF8E3");
        });
    </script>
</head>
<body>
<div class="ad_page">
    <div class="header">
        <img src="../images/logo.png">
        <div class="state">
            <div class="ad_name">
                <div class="fa_i"><i class="fa fa-user"></i></div>
                <a href="../html/adPersonal.html">管理员01</a></div>
            <div class="out"><a href="../html/index.html">退出</a></div>
        </div>
        <div class="clear"></div>
    </div>
    <div class="content">
        <div class="left">
            <ul>
                <a href="../html/adBorrowBook.html">
                    <li>读者借书
                        <div class="trig"></div>
                    </li>
                </a>
                <a href="../html/adReturnBook.html">
                    <li>读者还书
                        <div class="trig"></div>
                    </li>
                </a>
                <a href="../html/adAddBook.html">
                    <li>新书入库
                        <div class="trig"></div>
                    </li>
                </a>
                <a href="../html/adOutBook.html">
                    <li>图书出库
                        <div class="trig"></div>
                    </li>
                </a>
                <a href="../html/adAlterBook.html">
                    <li>修改图书信息
                        <div class="trig"></div>
                    </li>
                </a>
                <a href="../html/adCheckBook.html">
                    <li>查阅借阅记录
                        <div class="trig"></div>
                    </li>
                </a>
                <a href="../html/adSearchBook.html">
                    <li>查阅图书信息
                        <div class="trig"></div>
                    </li>
                </a>
                <a href="../html/adPersonal.html">
                    <li>管理员中心
                        <div class="trig"></div>
                    </li>
                </a>
            </ul>
        </div>
        <div class="right">
            <!-- class="ad_data"的div中是图书管理员系统的切换部分 -->
            <div class="ad_data">
                <div class="search">
                    <input type="text" id="searchInput" value="输入搜索信息" onfocus="if(value==='输入搜索信息') {value=''}"
                           onblur="if (value==='') {value='输入搜索信息'}"/>
                    <div class="btn" onclick="search(document.getElementById('searchInput').value)">搜索</div>
                </div>
                <form class="table_div" id="form">
                    <table class="table">
                        <thead>
                        <tr>
                            <th class="tdOne">图书编号</th>
                            <th>图书名称</th>
                            <th class="tdTwo">作者</th>
                            <th class="tdTwo">译者</th>
                            <th class="tdTwo">价格</th>
                            <th>出版社</th>
                            <th class="tdOne">出版日期</th>
                            <th>ISBN编码</th>
                            <th class="tdTwo">入库者</th>
                            <th class="tdOne">入库时间</th>
                            <th class="tdOne">是否借出</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                        <tr id="post">
                            <td><input disabled/></td>
                            <td><input name="bookName"></td>
                            <td><input name="author"/></td>
                            <td><input name="translator"/></td>
                            <td><input name="price"/></td>
                            <td><input name="publishCompany"/></td>
                            <td><input name="publishTime"/></td>
                            <td><input name="iSBN"/></td>
                            <td><input name="enteringPerson"/></td>
                            <td><input name="enteringDate"/></td>
                            <td><input name="state"/></td>
                            <td>
                                <input type="button" value="添加" onclick="post()">
                            </td>
                        </tr>
                        </tfoot>
                    </table>
                </form>

            </div>
        </div>
        <div class="clear"></div>
    </div>
</div>
</body>
<script>

    async function search(value) {
        const response = await fetch(`/book?bookName=${value}&author=${value}&translator=${value}&publishCompany=${value}`)
        const json = await response.json();
        document.querySelector('.table tbody').innerHTML = `
        ${json.map(e => `<tr id="${e.bookId}">
                            <td><input value="${e.bookId}" name="bookId" disabled/></td>
                            <td><input value="${e.bookName}" name="bookName"></td>
                            <td ><input value="${e.author}" name="author"/></td>
                            <td ><input value="${e.translator}" name="translator"/></td>
                            <td ><input value="${e.price}" name="price"/></td>
                            <td ><input value="${e.publishCompany}" name="publishCompany"/></td>
                            <td ><input value="${e.publishTime}" name="publishTime"/></td>
                            <td ><input value="${e.iSBN}" name="iSBN"/></td>
                            <td ><input value="${e.enteringPerson}" name="enteringPerson"/></td>
                            <td><input value="${e.enteringDate}" name="enteringDate"/></td>
                            <td ><input value="${e.state}" name="state"/></td>
                            <td>
                            <input type="button" class="save" value="保存" data-key="${e.bookId}">
                            <input type="button" class="delete" value="删除" data-key="${e.bookId}">
                            </td>
                        </tr>`).join('')}`
    }

    search('').then();

    document.querySelector('.table').addEventDelegate("click", "input.save", async e => {
        const id = e.currentTarget.dataset.key;
        const jsonArray = $(`#${id} :input`).serializeArray();
        const json = {};
        for (const i of jsonArray) json[i.name] = i.value;
        const response = await fetch(`/book/${id}`, {
            method: "put",
            credentials: "same-origin",
            body: JSON.stringify(json)
        });
        if (response.ok) {
            alert("保存成功!")
        }
    });

    document.querySelector('.table').addEventDelegate("click", "input.delete", async e => {
        const id = e.currentTarget.dataset.key;
        const response = await fetch(`/book/${id}`, {method: "delete", credentials: "same-origin"});
        if (response.ok) {
            alert("删除成功!")
        }
    });

    async function post() {
        const jsonArray = $(`#post :input`).serializeArray();
        const json = {};
        for (const i of jsonArray) json[i.name] = i.value;
        const response = await fetch(`/book`, {
            method: "post",
            credentials: "same-origin",
            body: JSON.stringify(json)
        });
        if (response.ok) {
            alert("添加成功!")
        }
    }
</script>
</html>